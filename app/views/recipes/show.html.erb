
<!-- recipe photo -->
<div class="photo" style="background-position: center; background-image: linear-gradient(rgba(0,0,0,0.1), rgba(0,0,0,0.3)), url(<%= cl_image_path(@recipe_photo_id, width: 800, height: 300, crop: :fill, gravity: :custom) %>)">
</div>


<div class="main">
  <!-- Recessed "add photo" link -->
  <% if current_user.id == @recipe.owner_id %>
    <div class="add-photo">
      <h3>
        <%= link_to '#', id:"upload_widget_opener"  do %>
          <i class="fa fa-plus-square" aria-hidden="true"></i>
          Add a photo
        <% end %>
      </h3>
    </div>
  <% end %>
  <!-- Recipe Name -->
  <div id="recipe-title" class="flex-wrap align-baseline space-between">
    <div class="flex align-baseline">
      <h1><%= @recipe.name.titleize %></h1>
      <div class="edit-buttons">
        <% if @recipe.owner_id == current_user.id %>
          <span class="editable hidden edit-button">
            <%= link_to '<i class="fa fa-pencil" aria-hidden="true"></i>'.html_safe,
                edit_recipe_path(@recipe),
                remote: true %>
          </span>
        <% end %>
      </div>
    </div>
    <div class="top-right-buttons">
      <div>
        <%= link_to "Delete",
                    recipe_path(@recipe),
                    method: :delete,
                    data: { confirm: 'Are you sure you wish to delete this recipe?' },
                    class: "btn btn-default" %>
      </div>
      <div class="edit-mode">
        <%= link_to "Edit", "#", class: "btn btn-primary" %>
      </div>
      <div class="edit-mode">
        <%= link_to "Save Edits", "#", class: "btn btn-primary hidden" %>
      </div>
    </div>
  </div>

  <!-- Recipe Owner Info -->
  <div class="mb-30">
    <% if @recipe.owner_id %>
      <p>
        <%= "#{@recipe.category.name.titleize} recipe by #{@recipe.owner}" %>
      </p>
    <% else %>
      <p>(this recipe has no owner)</p>
    <% end %>
  </div>

  <div class="mb-30">
    <p>
      <strong>Prep time:</strong><%= " #{ChronicDuration.output(@recipe.prep_time)}" %>
      <br>
      <strong>Cook time:</strong><%= " #{ChronicDuration.output(@recipe.cook_time)}" %>
      <br>
      <strong>Rest time:</strong><%= " #{ChronicDuration.output(@recipe.rest_time)}" %>
      <br>
    </p>
  </div>

  <!-- Recipe -->
  <div id="recipe">
    <div class="container-fluid">
      <div class="row">
        <div class="col-xs-12 col-sm-4">
          <!-- Ingredients -->
          <div class="ingredients-container">
            <div id="ingredients-title">
              <%= render 'ingredients/title' %>
            </div>
            <div id="ingredient-list">
              <%= render 'ingredient_list' %>
            </div>

            <!-- New Ingredient -->
            <% if current_user.id == @recipe.owner_id %>
              <div class="editable hidden">
                <%= link_to recipe_new_recipe_ingredient_path(@recipe), remote: true do %>
                  <i class="fa fa-plus-square" aria-hidden="true"></i>
                <% end %>
                <h3>Add ingredient</h3>
              </div>
            <% end %>
          </div>
        </div>
        <div class="col-xs-12 col-sm-8">
          <!-- Steps -->
          <div id="steps" class="steps-container">
            <!-- Steps Title -->
            <div id="steps-title">
              <%= render 'steps/title' %>
            </div>
            <!-- Steps list -->
            <div id="step-list">
              <%= render 'steps/show' %>
            </div>
            <!-- New step form -->
            <div class="new-step editable hidden">
              <% if current_user.id == @recipe.owner_id %>
                <%= link_to '<i class="fa fa-plus-square" aria-hidden="true"></i>'.html_safe, new_recipe_step_path(@recipe),  {:remote => true}  %>
                <h3>Add a step</h3>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Comments -->
  <div id="comments-container">
    <%= render 'comments/show', recipe: @recipe %>
  </div>
  <!-- New Comment -->
  <div id="new-comment">
    <%= render 'comments/form', recipe: @recipe, comment: Comment.new %>
  </div>
</div>


<!-- cloudinary uploader -->
<% if current_user.id == @recipe.owner_id %>
  <script src="//widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  <script>
    document.getElementById("upload_widget_opener").addEventListener("click", function() {
      cloudinary.openUploadWidget({ cloud_name: 'nicohoya',
        upload_preset: 'epmcvfws',
        theme: 'minimal',
        multiple: false,
        cropping: 'server',
        max_file_size: 5000000,
        sources: [ 'local', 'url', 'camera', 'image_search', 'facebook', 'instagram' ]
         },
        function(error, result) {
          if (error == null){
            $.ajax({
              type: "POST",
              beforeSend: function(xhr) {xhr.setRequestHeader('X-CSRF-Token', $('meta[name="csrf-token"]').attr('content'))},
              url: '<%= j recipe_photos_path(@recipe) %>',
              data: {
                recipe_id: <%= @recipe.id %>,
                image_id: result["0"].public_id
              },
            })
          } else {
            console.log("Error with Cloudinary image upload")
          }
          console.log(error, result)
        });
    }, false);
  </script>
<% end %>
